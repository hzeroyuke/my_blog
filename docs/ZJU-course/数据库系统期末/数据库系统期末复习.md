# æ•°æ®åº“ç³»ç»ŸæœŸæœ«å¤ä¹ 

!!! note "æ•°æ®åº“å­¦ä¹ ç¬”è®°"
	å¤§äºŒä¸‹å¹³æ—¶èŠ±è´¹æ—¶é—´æœ€é•¿çš„è¯¾ï¼Œ4ä¸ªç»ƒä¹ ProjectåŠ ä¸Šå›¾ä¹¦ç®¡ç†ç³»ç»Ÿå’ŒMiniSQLï¼Œä½†è¿™å…¶å®è¿˜å¥½ï¼Œå› ä¸ºå®éªŒå…¶å®è®¾è®¡çš„è´¨é‡è¿˜å¯ä»¥ï¼ŒMiniSQLä¹Ÿå¾ˆæœ‰æŒ‘æˆ˜æ€§ã€‚99%æ¶å¿ƒç‚¹è¿˜æ˜¯åœ¨æœŸæœ«è€ƒè¯•ï¼Œä»Šå¹´çªç„¶å˜æˆ19é“å¤šé€‰ï¼Œå°¤å…¶æ˜¯æœŸæœ«å†å¹´å·ç­”æ¡ˆæå…¶ç¦»è°±ï¼Œå„å®¶è€å¸ˆPPTä¾§é‡è¿˜å„ä¸ç›¸åŒï¼Œå¤ä¹ æ•ˆæœä¸ä½³ä¸è¯´ï¼Œæµªè´¹äº†å¤§é‡æ—¶é—´ã€‚æˆ‘æ˜¯è‹—è€å¸ˆç­çš„å­¦ç”Ÿï¼Œè‹—è€å¸ˆä¸Šè¯¾å¹¶ä¸æ˜¯å¤ªå‡ºå½©ï¼Œå¹¶ä¸”å°æµ‹è¾ƒå¤šï¼Œä½†æ˜¯è¿™å­¦æœŸçš„åŠ©æ•™è€å¸ˆå°æµ‹éƒ½æ‰¹çš„å¾ˆå®½ï¼ŒéªŒæ”¶ä¹Ÿæ¯”è¾ƒå®½æ¾ï¼Œè¿˜æ˜¯å»ºè®®é€‰çš„ã€‚

## 3. èŒƒå¼

å¥½çš„relational design

normalizationçš„ç›®æ ‡

* åˆ†è§£ä¸€å®šæ˜¯æ— æŸ
* ä½†æ˜¯æœ€å¥½ä¿æŒä¾èµ–

â€‹![image](assets/image-20240619135213-vjt61s0.png)â€‹

æ»¡è¶³åé¢çš„ä¸€å®šæ»¡è¶³å‰é¢çš„

* 1NF the domains of all attributes of R are atomic
* 2NF
* 3NF

  * æ¡ä»¶ï¼ŒBCNFçš„æ¡ä»¶ï¼Œå†åŠ ä¸Šä¸€æ¡ $a\rightarrow b$ å¦‚æœ b-a(å¦‚æœaä¸åœ¨bä¸­ï¼Œé‚£ä¹ˆb-a=b) è¢«åŒ…å«åœ¨candidate keyä¸­
* BCNF

  * æ¡ä»¶
  * å¦‚ä½•æ‹†åˆ†ï¼Œä¸ä¸€å®šéœ€è¦ä»æ­£åˆ™è¦†ç›–å¼€å§‹ï¼Œä¸æ–­åœ°ä»åŸé›†åˆä¸­æ‹†å‡ºå»ï¼Œä½†æ˜¯åŸé›†åˆä¾æ—§é€‚ç”¨äºä»¥å‰æ‰€æœ‰çš„ä¾èµ–
* 4NF

  * â€‹![image](assets/image-20240619140000-vfx3e4b.png)â€‹
  * æ»¡è¶³4NFä¸€å®šæ»¡è¶³BCNF

â€‹![image](assets/image-20240619135707-3z0ye4z.png)â€‹

æ— æŸåˆ†è§£ï¼Œä¸¤ç§åˆ¤å®šæ–¹å¼

â€‹![image](assets/image-20240620101742-80k35wv.png)â€‹

### å‡½æ•°é—­åŒ…

### æ­£åˆ™è¦†ç›–

æ­£åˆ™è¦†ç›–æœªå¿…æ˜¯å”¯ä¸€çš„

### æ— æŸåˆ†è§£

### ä¾èµ–ä¿æŒ

### BCNF

### 3NF

æ¶‰åŠæ­£åˆ™è¦†ç›–

ç®—candidate key

## 4. æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢

### 4.1 replacer * MRU

**clock replacer**

â€‹![image](assets/image-20240616183331-q5pk1xn.png)â€‹

å¯¹äºä¸Šé¢çš„æ¯ä¸ªç‚¹éƒ½ç»´æŠ¤ä¸¤ä¸ªå±æ€§pin countå’Œreference bitï¼Œå¦‚æœæŸä¸ªç‚¹è¢«è®¿é—®ï¼Œåˆ™å°†reference bitç½®ä¸º1ï¼Œæ¯æ¬¡è¦æ›¿æ¢çš„æ—¶å€™ï¼ŒæŒ‡é’ˆæ—‹è½¬ï¼Œå¦‚æœreference bitä¸º0å°±æ›¿æ¢å‡ºæ¥ï¼Œå¦‚æœä¸ä¸º0ï¼Œå°±å°†reference bitç½®ä¸º0ï¼Œæ—‹è½¬åˆ°ä¸‹ä¸€ä¸ª

ç©ºé—´å±€éƒ¨æ€§

æ—¶é—´å±€éƒ¨æ€§

è¦è®¡ç®—ä¸€ä¸ªtableé‡Œé¢çš„å äº†å¤šå°‘ä¸ªblockï¼Œé¦–å…ˆæŠŠblock size / record sizeï¼Œå¹¶ä¸”å‘ä¸‹å–æ•´ï¼Œç„¶ååœ¨æŠŠrecordä¸ªæ•°/ä¸Šè¿°ç»“æœï¼Œç„¶åå‘ä¸Šå–æ•´

**MRU**

system must pin the block currently being processed. After the final tuple of that block has been processed, the block is unpinned, and it becomes the most recently used block.

å°†æœ€è¿‘ä½¿ç”¨çš„ä½œä¸ºæ›¿æ¢å—

**toss-immediate strategy**

frees the space occupied by a block as soon as the final tuple of that block has been processed ç”¨å®Œä¹‹åé©¬ä¸Šfree

### 4.2 ç‰©ç†çš„å­˜å‚¨

**å­˜å‚¨å±‚æ¬¡**

* volatileæ˜“å¤±å­˜å‚¨ cache, main memory
* non-volatileä¸æ˜“å¤±å­˜å‚¨ flash memory, disk...
* ä¸‰çº§å­˜å‚¨

**ç£ç›˜å­˜å‚¨**

ç£ç›˜æœ‰å¤šä¸ªç›˜ç‰‡(platter)ï¼Œç£ç‰‡ä¸Šé¢æœ‰ä¸€ä¸ªè¯»å†™å¤´(read-write head)ï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œç£ç›˜ä»¥æ’å®šçš„é€Ÿåº¦æ—‹è½¬ï¼Œè®©è¯»å†™å¤´æ¥è¯»å†™ã€‚

ç›˜ç‰‡çš„è¡¨é¢åˆ†ä¸ºä¸€ä¸ªä¸ªç£é“ï¼ˆtrackï¼‰ï¼Œç£é“åˆåˆ†ä¸ºæ‰‡åŒºï¼ˆsectorï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ä¸€ä¸ªç£ç›˜æœ‰1-5ä¸ªç›˜ç‰‡ï¼Œä¸€ä¸ªç›˜ç‰‡æœ‰50000-100000ä¸ªç£é“ï¼Œæ¯ä¸ªç£é“æœ‰500-1000çš„æ‰‡åŒºï¼Œæ¯ä¸ªæ‰‡åŒºä¸€èˆ¬éƒ½æ˜¯512å­—èŠ‚

å½“ä¸€ä¸ªç£ç›˜å¤´åœ¨ç¬¬iä¸ªç£é“çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ç£ç›˜å¤´éƒ½åœ¨ç¬¬iä¸ªç£é“ï¼Œæ‰€æœ‰ç›˜ç‰‡çš„ç¬¬iä¸ªç£é“æ„æˆäº†ç¬¬iä¸ªæŸ±é¢

**ç£ç›˜æ§åˆ¶å™¨disk controller**

ç£ç›˜ç»™è®¡ç®—æœºçš„æ¥å£ä¹Ÿæœ‰å¤šç§

* SATA
* SCSI
* SAS

**ç£ç›˜æ€§èƒ½çš„åº¦é‡**

æˆ‘ä»¬æœ‰å¤šä¸ªæŒ‡æ ‡æ¥è¡¡é‡ç£ç›˜çš„æ€§èƒ½

* access time = seek time(å¯»é“æ—¶é—´) + rotational latency time(æ—‹è½¬åˆ°æ‰‡åŒºæ—¶é—´) +æ•°æ®é‡/æ•°æ®ä¼ è¾“ç‡(data-transfer rate)
* Mean Time to Failure(MTTF)å¹³å‡æ•…éšœæ—¶é—´ï¼Œç°ä»£ç£ç›˜ä¸€èˆ¬åœ¨500 000 - 1200 000å°æ—¶å†…

**ç£ç›˜å—è®¿é—®ä¼˜åŒ–**

æ“ä½œç³»ç»Ÿå‘ç£ç›˜æ•°æ®çš„è·å–ä¸€èˆ¬æ˜¯ä»¥å—blockä¸ºå•ä½çš„ï¼Œä¸€ä¸ªå—å¤§æ¦‚åœ¨512å­—èŠ‚åˆ°å‡ KBä¹‹é—´ã€‚åŒæ—¶è¿˜è¢«åˆ†ä¸ºéšæœºè®¿é—®å’Œé¡ºåºè®¿é—®ä¸¤ç§

ä¸ºäº†æé«˜è®¿é—®å—çš„é€Ÿåº¦ï¼Œäº§ç”Ÿäº†è®¸å¤šæŠ€æœ¯

* buffering

**optimization of disk block access**

* non-volatile wrtie bufferï¼Œä¾‹å¦‚battery backed up RAM æˆ–è€… flash memory æˆ–è€…NVM
* log disk ä¸“é—¨ä¸€ä¸ªç£ç›˜æ¥å†™æ—¥å¿—ï¼Œéƒ½æ˜¯é¡ºåºå†™çš„ï¼Œ

  * write is fast and no seeks are required
  * no need for special hardware

**flash storage**

* NAND flashï¼Œæ¯”NOR flashæ›´ä¾¿å®œ

  * require page-at-a-time readï¼ˆï¼‰not much difference between sequential and random read
  * page can only be written once
* SSD

  * block-oriented disk interfaces ä½†æ˜¯ç”¨çš„æ˜¯é—ªå­˜å­˜æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨ç£ç›˜çš„æ¥å£ï¼Œä½†æ˜¯ç”¨é—ªå­˜å­˜å‚¨

â€‹![image](assets/image-20240617154328-117lvvg.png)â€‹

å…¶ç¼ºé™·åœ¨äºéœ€è¦å…ˆæ“¦é™¤ï¼Œå†å†™ erase->rewrite

* ä¼˜åŒ–ç›®æ ‡æ˜¯å°‘eraseï¼Œä½¿å¾—å„ä¸ªå—ç£¨æŸçš„å¹³å‡ä¸€ç‚¹ï¼Œæ¯”å¦‚æ•°æ®æœ‰é€»è¾‘æ ‡å¿—å’Œç‰©ç†æ ‡å¿—ï¼Œä½¿å¾—å…¶é€»è¾‘å­˜åœ¨å’Œç‰©ç†åœ°å€å¯ä»¥åˆ†ç¦»ï¼Œæ¯”å¦‚è¯´å»ºç«‹remappingæœºåˆ¶
* wear leveling ç£¨æŸå‡è¡¡- evenly distributed erase operators across physical blocks
* â€‹![image](assets/image-20240617155512-wspk0fr.png)â€‹

å„ç§ä»‹è´¨çš„æ¯”è¾ƒ

â€‹![image](assets/image-20240617155825-l4d0rwm.png)â€‹

byte-address - block-addresss

endurance æ˜¯è€ä¹…å€¼

### 4.3 æ–‡ä»¶ç»“æ„

ä¸€ä¸ªæ•°æ®åº“å†…éƒ¨æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶æ˜¯a sequence of records, ä¸€ä¸ªrecordæ˜¯ a sequence of fieldsã€‚æ›´å‡†ç¡®çš„è¯´æ³•æ˜¯æ¯ä¸ªæ–‡ä»¶è¢«åˆ†ä¸ºå®šé•¿çš„å­˜å‚¨å•å…ƒ ä¹Ÿå°±æ˜¯blockï¼Œå¯¹äºblocké‡Œé¢å¦‚ä½•å­˜å‚¨recordï¼Œæœ‰ä¸€äº›åšæ³•ï¼Œæ¯”å¦‚

#### Fixed-Length Records

æˆ‘ä»¬å¯ä»¥æŠŠæ¯ä¸ªè®°å½•ç´§å¯†åœ°æ’åˆ—ï¼Œæ¯ä¸ªå—å­˜å‚¨èƒ½å­˜å‚¨çš„æœ€å¤§æ•°é‡çš„recordsï¼Œä½†å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå½“æˆ‘ä»¬åˆ é™¤ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œæ˜¯å¦è¦æŠŠåé¢çš„æ‰€æœ‰è®°å½•éƒ½æŒªä¸€ä¸Šæ¥ä¸€æ ¼ï¼Œè¿™ä¹ˆåšæ˜¾ç„¶æ˜¯ç›¸å½“éº»çƒ¦çš„ã€‚

å¯ä»¥è€ƒè™‘è¿™ç§åšæ³•ï¼Œåœ¨blockçš„å¼€å¤´æ”¾ä¸€äº›æ•°æ®ä½œä¸ºå…ƒæ•°æ®ï¼Œå¯ä»¥å­˜å‚¨ç©ºåˆ—è¡¨çš„å¼€å¤´ä½ç½®ï¼Œç„¶åå°†ç©ºé—²çš„åœ°æ–¹éƒ½ä½œä¸ºé“¾è¡¨ä¸²èµ·æ¥ï¼Œè¿™æ ·å°±å¯ä»¥ä¸å½±å“æ’å…¥æ•ˆç‡çš„æƒ…å†µä¸‹ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç©ºé—´

#### variable-Length Records

æˆ‘ä»¬éœ€è¦å˜é•¿è®°å½•çš„åŸå› æœ‰

ä¸€èˆ¬çš„å˜é•¿recordï¼Œå¼€å¤´ä¹Ÿä¼šæœ‰ä¸€äº›å®šé•¿å±æ€§ï¼Œä¸€èˆ¬å°±æ˜¯offset+lengthï¼Œoffsetè¡¨ç¤ºè¯¥è®°å½•ä¸­è¯¥å±æ€§çš„æ•°æ®å¼€å§‹çš„ä½ç½®ï¼Œlengthè¡¨ç¤ºé•¿åº¦ã€‚å¦‚ä¸‹å›¾ï¼Œå‰ä¸‰å¯¹å±æ€§å°±æ˜¯å¯¹äºä¸‰ä¸ªå˜é•¿å±æ€§çš„æè¿°

â€‹![image](assets/image-20240608191635-20b89uk.png)â€‹

é€šå¸¸è¿™é‡Œè¿˜ä¼šæœ‰ç©ºä½å›¾çš„ä½¿ç”¨null-value bitmapï¼Œè¯¥å›¾è¡¨ç¤ºé‚£äº›å±æ€§æ˜¯ç©ºçš„

ä¸Šè¿°è®²è¿°äº†å˜é•¿recordå†…éƒ¨çš„ç»“æ„ï¼Œé‚£ä¹ˆrecordæœ¬èº«åœ¨blockä¸­æ˜¯å¦‚ä½•å­˜å‚¨çš„å‘¢ï¼Œä¸€èˆ¬æ˜¯é‡‡ç”¨slotted-page structureï¼Œåœ¨è¯¥ç»“æ„çš„è¡¨å¤´ï¼Œå­˜å‚¨ç€

* blockä¸­çš„recordæ•°é‡
* ç©ºé—²ç©ºé—´çš„æœ«å°¾
* ä¸€ä¸ªç”±è®°å½•ä½ç½®+å¤§å°çš„è®°å½•æ¡ç›®æ„æˆçš„æ•°ç»„

â€‹![image](assets/image-20240608192413-78qmzkm.png)â€‹

å®é™…çš„è®°å½•è¦ä»blockçš„å°¾éƒ¨å¼€å§‹è¿ç»­æ’åˆ—ï¼Œç©ºé—²ç©ºé—´æ˜¯è¿ç»­çš„ï¼Œrecordä¹‹é—´ä¹Ÿæ˜¯è¿ç»­çš„ï¼Œå½“recordè¢«åˆ é™¤äº†ï¼Œrecordå‰é¢çš„è®°å½•è¦åç§»ï¼Œç»™FreeSpaceæä¾›ç©ºé—´

record pointerä¸åº”è¯¥ç›´æ¥æŒ‡å‘è®°å½•ï¼Œåº”è¯¥æŒ‡å‘headeré‡Œçš„entry

#### æ–‡ä»¶ä¸­è®°å½•çš„ç»„ç»‡

* heap
* sequential
* hashing file organization
* multitable clustering file

**heap file organization**

recordå¯èƒ½è¢«ä¸¢åœ¨æ–‡ä»¶ä»»ä½•ç©ºé—²çš„åœ°æ–¹ï¼Œå…³é”®åœ¨äºFree-space mapï¼Œç”¨äºå¿«é€Ÿæ‰¾åˆ°ç©ºé—²ä½ç½®

free space map

â€‹![image](assets/image-20240617162358-heaxo8h.png)â€‹

ä¸Šè¿°çš„æ¯ä¸ªå°æ–¹å—é‡Œé¢æ”¾3ä¸ªbitï¼Œè¡¨ç¤º0-7ï¼Œç”¨æ¥è¡¨ç¤ºå¯¹åº”çš„blockï¼Œæœ‰n/8çš„ç©ºé—²ï¼Œä½†æ˜¯å¦‚æœæ–‡ä»¶çš„å—å¾ˆå¤šï¼Œå°±å¯ä»¥å¤šç”Ÿæˆå‡ å±‚ï¼Œæ¯”å¦‚ä¸Šå›¾ï¼Œfirst levelçš„å››å—å¯¹åº”second levelçš„ä¸€å—ï¼Œsecond levelé‡Œé¢å°±å­˜å››å—é‡Œé¢æœ€å¤§çš„ç©ºé—²

æˆ‘è¿™ä¸ªæ–‡ä»¶é‡Œæœ‰å¾ˆå¤šblockï¼Œæˆ‘è¦ç”¨free space mapå»æè¿°ä»–ä»¬ç©ºé—²çŠ¶æ€

**sequential**

é¡ºåºæ–‡ä»¶æ˜¯ä¸ºäº†é«˜æ•ˆå¤„ç†æŒ‰æŸä¸ªæœç´¢ç çš„é¡ºåºæ’åºçš„è®°å½•è€Œè®¾è®¡çš„ï¼Œæˆ‘ä»¬ç”¨æŒ‡é’ˆæŠŠè®°å½•æŒ‰ç…§è¿™ä¸ªç çš„é¡ºåºé“¾æ¥èµ·æ¥

deletion:æŠŠç©ºé—²çš„ä¸²èµ·æ¥

insertion:

* å¦‚æœæœ‰free spaceå°±æ’
* æ²¡æœ‰free space å°±æ’åˆ° overflow block
* éƒ½è¦æ›´æ–°pointer chain

need to reorganize the file from time to time

åŒæ ·çš„æ’å…¥å’Œåˆ é™¤ï¼Œä¹Ÿéœ€è¦æŒ‰ç…§é“¾è¡¨çš„åšæ³•å»åš

**multitable clustering File Organization**

æŠŠå¤šä¸ªè¡¨å­˜åœ¨åŒä¸€ä¸ªfileä¸­çš„åšæ³•ï¼Œåœ¨å¤§å‹æ•°æ®åº“ä¸­ï¼Œä½¿ç”¨å°†ä¸€ä¸ªæ–‡ä»¶åˆ†ä¸ºblockçš„åšæ³•æ˜¯æœ‰æ€§èƒ½ä¸Šçš„å¥½å¤„çš„ï¼Œæ¯ä¸ªblockè¿˜æ˜¯ä¼šå­˜å‚¨ä¸€ä¸ªè¡¨ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ä¸ä¾èµ–æ“ä½œç³»ç»Ÿè‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ•°æ®åº“ç³»ç»Ÿè‡ªå·±ç®¡ç†è¿™ä¸ªæ–‡ä»¶

store several relations in one file

åŒæ—¶è¿™ç§æ–‡ä»¶ç»„ç»‡ï¼Œè¿˜æ”¯æŒåœ¨ä¸€ä¸ªblockå­˜å‚¨ä¸¤ä¸ªæˆ–å¤šä¸ªrelationçš„ç›¸å…³recordsï¼Œå¯ä»¥æ›´é«˜æ•ˆçš„å¤„ç†joinç›¸å…³çš„æŸ¥è¯¢ï¼Œä½†æ˜¯ç›¸å¯¹çš„å…¶ä»–ç±»å‹çš„æŸ¥è¯¢ä¼šå˜æ…¢ã€‚

ä¸ºäº†æœ‰é€»è¾‘çš„å­˜å‚¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†åŒä¸€ä¸ªè¡¨çš„è®°å½•ç”¨é“¾è¡¨ä¸²èµ·æ¥

â€‹![image](assets/image-20240617163403-qton0jm.png)â€‹

**table partitioning**

records in relation can be partitioned into smaller relations that are stored separately

* æŒ‰æ°´å¹³partition

  * æ¯”å¦‚æŒ‰ç…§å­¦ç”Ÿçš„æ‰€å±å­¦é™¢åˆ†
* æŒ‰å‚ç›´partition

  * æ¯”å¦‚å°†ä¸€äº›å±æ€§æ”¾åœ¨ä¸€ä¸ªrelation

**data dictionary storage**

è¿™éƒ¨åˆ†åˆç§°ä¸ºsystem catalogï¼Œä¹Ÿå°±æ˜¯å…³ç³»çš„å…ƒæ•°æ®å­˜å‚¨ï¼ŒåŒæ—¶è¿˜ä¼šå­˜å‚¨ä¸€äº›ç”¨æˆ·çš„ä¿¡æ¯

â€‹![image](assets/image-20240609213232-27lv52f.png)â€‹

â€‹![image](assets/image-20240617164014-fvatimn.png)â€‹

### 4.4 buffer Manager

Blockæ˜¯ç£ç›˜è¯»å†™çš„æœ€å°å•ä½ï¼Œbuffer managerå­˜åœ¨çš„ç›®çš„æ˜¯æœ€å°åŒ–è¯»å†™æ¬¡æ•°

**LRU** 

â€‹![image](assets/image-20240609213500-wd8as51.png)â€‹

**buffer manager**

æ•°æ®åº“ç³»ç»Ÿå‘å‡ºblockè¯·æ±‚

* å·²ç»åœ¨bufferé‡Œé¢äº†ï¼Œç›´æ¥ç»™ä¸»å­˜é‡Œçš„åœ°å€
* è¿˜ä¸åœ¨buffer é‡Œé¢

  * buffer é‡Œé¢æœ‰ç©ºä½å°±ç›´æ¥è¯»ä¸€ä¸ªè¿›æ¥
  * bufferé‡Œé¢æ²¡ç©ºä½å°±ç”¨æ›¿æ¢ç­–ç•¥æ›¿ä»£ä¸€ä¸ªï¼Œå¦‚æœæ˜¯è„é¡µï¼Œè¡¨è¿°ä¸º(it was modified since the most recent time that it was written to/fetch from disk) è¦å†™å›ç£ç›˜

ä¸€äº›ç‰¹æ€§

* pinning block æ˜¯æŒ‡ä¸å…è®¸è¢«å†™å›ç£ç›˜çš„memory blockï¼Œè¯»å†™ä¹‹å‰éœ€è¦pinï¼Œè¯»å†™å®Œæˆåéœ€è¦unpinï¼Œéœ€è¦ç»´æŠ¤ä¸€ä¸ªpin countï¼Œå½“å…¶ä¸º0çš„æ—¶å€™æ‰èƒ½evict
* shared and exclusive locks on buffer

  * éœ€è¦é˜²æ­¢å¹¶å‘çš„move/reorganizeæ“ä½œï¼Œä»¥åŠåœ¨move/reorganizeæ“ä½œæœŸé—´çš„è¯»
  * readeréœ€è¦shared lock, update éœ€è¦ exclusive lock
  * â€‹![image](assets/image-20240609215636-0k4oktn.png)â€‹
* â€

**æ›¿æ¢ç­–ç•¥**

LRUæ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ›¿æ¢ç­–ç•¥ï¼Œåœ¨ä¸€ä¸ªwell-defined access pattern æ¯”å¦‚é¡ºåºæ‰«æä¸­è¡¨ç°è‰¯å¥½ï¼Œåœ¨ä¸€äº›ç‰¹å®šçš„å­˜åœ¨repeated scans çš„ access patternï¼Œå¯èƒ½è¡¨ç°ä¸å¥½

* Toss-immediate strategy
* MRU strategy
* Clock å¯¹LRUçš„ä¸€ç§æ¨¡æ‹Ÿ

**Column-Oriented Storage**

* ä¼˜åŠ¿
* åŠ£åŠ¿

**buffer tree**

### 4.5 æŒ‰åˆ—å­˜å‚¨

Store each attribute of a relation separately

â€‹![image](assets/image-20240619100728-sok4dek.png)â€‹

ç®€å•æ¥è¯´å°±æ˜¯åˆ©äºéƒ¨åˆ†å±æ€§çš„æŸ¥è¯¢ï¼Œcacheå’Œcompressionï¼Œç¼ºé™·åœ¨äºdeletion, update and reconstruction

* åˆ—å­˜å‚¨æ›´åˆ©äº decision support
* è¡Œå­˜å‚¨æ›´åˆ©äº transaction process

Some databases support both representations Called hybrid row/column stores

â€‹![image](assets/image-20240619101332-zw85c5v.png)â€‹

## 5. indexing

### 5.1 **ä¸€äº›åŸºç¡€çš„æ¦‚å¿µ**

indexing mechanism used to speed up access to desired data

* search key ç”¨äºæŸ¥æ‰¾è®°å½•çš„å±æ€§é›†
* index file å­˜å‚¨ç€ä¸€ç³»åˆ—å½¢å¦‚search key - pointer çš„è®°å½•ï¼Œå…¶ä¸€èˆ¬éƒ½è¿œå°äºåŸæ–‡ä»¶
* ä¸€èˆ¬æœ‰ä¸¤ç§ç´¢å¼•å½¢å¼

  * ordered indicesæ˜¯æŒ‡search keyä»¥sorted orderè¢«å­˜å‚¨
  * Hash indicesæ˜¯æŒ‡search keyä½¿ç”¨hash functionå‡åŒ€å­˜åœ¨bucketé‡Œ
* æœ‰ä¸€ç³»åˆ—çš„è¯„ä»·æŒ‡æ ‡
* â€‹![image](assets/image-20240610121552-obg3uf7.png)â€‹

### 5.2 Ordered Indices

é¡ºåºç´¢å¼•æŒ‰ç…§æŸç§æ ‡å‡†å¯ä»¥åˆ†ä¸ºä¸¤ç±»

* primary index åˆå«clustering indexï¼Œæ˜¯æŒ‡è¢«ç´¢å¼•çš„è®°å½•æœ¬èº«å°±æŒ‰ç…§æŸä¸ªsearch keyé¡ºåºå­˜å‚¨ï¼Œè™½è¯´å«primary keyï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶ä¸ä¸€å®šæŒ‰ç…§primary keyï¼Œç”¨ä»»æ„ä¸€ä¸ªkeyå‡å¯ï¼Œä¸€èˆ¬æ˜¯primary key
* secondary key åˆå«nonclustering indexï¼Œä¸ä¸Šè¿°æ¦‚å¿µç›¸å¯¹ï¼Œæœ¬èº«ä¸æŒ‰ç…§è¯¥keyæ’åº

index-sequential fileæ˜¯æŒ‡å­˜åœ¨primary keyçš„æ–‡ä»¶

â€‹![image](assets/image-20240610122627-kc8erwp.png)â€‹![image](assets/image-20240610122639-niivrbt.png)â€‹

â€

index entry æˆ–è€…å« index recordï¼Œæ˜¯æŒ‡ä¸€ä¸ªsearch key - pointer å¯¹

* Dense index file æ–‡ä»¶ä¸­çš„æ¯ä¸€ä¸ªsearch keyéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„index entryï¼Œå”¯ä¸€çš„ä¾‹å¤–æ˜¯å½“è¿™ä¸ªæ–‡ä»¶æ˜¯index-sequential file/clustering indexçš„æ—¶å€™ï¼Œå¯ä»¥è®©index entryæŒ‡å‘ç›¸åŒçš„search keysçš„ç¬¬ä¸€ä¸ª
* Sparse index åªä¸ºæœç´¢ç çš„æŸäº›å€¼å»ºç«‹ç´¢å¼•ï¼Œæ­¤æ—¶å¿…é¡»æ˜¯clustering indexï¼Œé¡ºç€è¿™ä¸ªç´¢å¼•æ‰¾ï¼Œå¯ä»¥ç¡®å®šä¸€å®šèŒƒå›´å†…çš„æ•°æ®ï¼Œç¨€ç–ç´¢å¼•+æ’åºçš„åŠ é€Ÿ

ç¨€ç–ç´¢å¼•çš„spaceå’Œmaintenanceå¼€é”€æ›´å°ï¼Œä½†æ˜¯æŸ¥æ‰¾æ›´æ…¢

Good tradeoff: sparse index with an index entry for every block in file,corresponding to least search-key value in the block.

**multilevel index**

æˆ‘ä»¬æå‡ºè¦å»ºç«‹primary indexï¼Œä½†æ˜¯éšç€tableçš„å˜å¤§ï¼Œæˆ‘ä»¬çš„primary indexä¹Ÿä¼šéšä¹‹å˜å¤§ï¼Œç›´åˆ°ä¸èƒ½å†æ”¾åˆ°å†…å­˜é‡Œï¼Œè¿™æ ·primary indexçš„ä½¿ç”¨å°±å˜å¾—éº»çƒ¦äº†ï¼Œä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ³•å°±æ˜¯ç»™primary indexåˆ†æ®µå»ºç«‹sparse index

â€‹![image](assets/image-20240610123857-6nvkpdr.png)â€‹

å½“outer indexä¹Ÿè¿‡å¤§çš„æ—¶å€™ï¼Œå°±å†åœ¨å…¶ä¸Šå»ºç«‹ä¸€å±‚indexï¼Œäºæ˜¯æˆ‘ä»¬æœ‰äº†å¤šå±‚ç´¢å¼•

â€

### 5.3 **B+ tree index**

B+æ ‘ç´¢å¼•æ–‡ä»¶æ˜¯å¯¹indexed-sequential filesçš„ä¸€ç§ä¼˜åŒ–ï¼Œè™½ç„¶ç›¸å¯¹ç¨å¾®æé«˜äº†ä¸€äº›insertionå’Œdeletionçš„å¼€é”€ï¼Œä½†æ˜¯bpæ ‘ç´¢å¼•çš„ä¼˜ç‚¹æ›´å¤§ï¼Œå› æ­¤è¢«å¹¿æ³›ä½¿ç”¨

bpæ ‘æ˜¯ä¸€ç§å¤šçº§ç´¢å¼•ï¼Œå…¶æœ‰ä»¥ä¸‹ç‰¹æ€§

Nä¸ªæŒ‡é’ˆï¼ŒN-1ä¸ªkey

* All paths from root to leaf has same length
* éæ ¹éå¶çš„å†…éƒ¨èŠ‚ç‚¹ï¼Œæœ‰$\lceil n/2\rceil -n$ ä¸ªchildren
* å¶å­èŠ‚ç‚¹ï¼Œæœ‰$\lceil(n-1)/2\rceil - (n-1)$ä¸ªvalues
* root èŠ‚ç‚¹

  * ä¸æ˜¯å¶å­ï¼Œæœ€å°‘ä¸¤ä¸ªchildren
  * æ˜¯å¶å­ï¼Œ0 - (n-1) ä¸ªvalues

â€‹![image](assets/image-20240610124952-ni5pa9d.png)â€‹

å¶å­èŠ‚ç‚¹

â€‹![image](assets/image-20240610125152-aaabif5.png)â€‹

bpæ ‘ç´¢å¼•çš„ä¸€äº›ç‰¹æ€§

* â€‹![image](assets/image-20240610125421-y50zsr8.png)â€‹
* â€‹![image](assets/image-20240610125528-z1l1c4q.png)â€‹
* insertionï¼Œå¦‚æœèƒ½æ­£å¸¸æ’å…¥åˆ™æ’å…¥ï¼Œåä¹‹ä¾¿è¦åˆ†è£‚

  * åˆ†è£‚çš„æ–¹æ³•ï¼Œå°†ç¬¬$0-\lceil n/2\rceil$ ä¸ªå…ƒç´ æ”¾åœ¨åŸå§‹çš„nodeï¼Œå‰©ä½™çš„å…ƒç´ æ”¾åˆ°æ–°çš„nodeï¼Œå¹¶ä¸”å°†æœ€å°çš„keyå’Œè‡ªèº«çš„åœ°å€på‘é€åˆ°çˆ¶èŠ‚ç‚¹
* deletion å¯èƒ½éœ€è¦è°ƒæ•´ç»“æ„

  * Mergeï¼šå¦‚æœå…„å¼ŸèŠ‚ç‚¹çš„å…ƒç´ æ•°ä¹‹å’Œå¯ä»¥å®¹çº³åœ¨ä¸€ä¸ªnodeé‡Œé¢ï¼Œå°±åˆå¹¶ï¼Œä¸€èˆ¬æ˜¯å‘å³è¾¹æ‰¾å…„å¼ŸèŠ‚ç‚¹å…ˆï¼Œç„¶åå°†å³è¾¹çš„å…„å¼Ÿåˆå¹¶åˆ°å·¦è¾¹ï¼Œåˆ é™¤å³è¾¹èŠ‚ç‚¹
  * Redistributeï¼šå¦‚æœä¸èƒ½å®¹çº³ï¼Œå°±è°ƒæ•´å…¶å’Œå…„å¼ŸèŠ‚ç‚¹ä¹‹é—´çš„å…ƒç´ æ•°ï¼Œå¹¶ä¸”åœ¨çˆ¶äº²ç»“ç‚¹é‡Œè°ƒæ•´æŒ‡é’ˆ
  * deletion may cascade upwards
  * å¦‚æœroot nodeè¢«åˆ é™¤åˆ°äº†åªæœ‰ä¸€ä¸ªpointerï¼Œé‚£ä¹ˆå…¶å°†è¢«åˆ é™¤ï¼Œå¹¶ä¸”å…¶å”¯ä¸€çš„childå°†æˆä¸ºæ–°çš„root
* â€‹![image](assets/image-20240610131025-4zw2k0m.png)â€‹
* è€Œåœ¨å®é™…æƒ…å†µä¸‹IOä¼šæ›´å°‘ï¼Œå› ä¸ºnodeå¯èƒ½åœ¨bufferä¸­ï¼Œå¹¶ä¸”åˆ†è£‚å’Œåˆå¹¶æ˜¯å°‘çš„

non-unique search key

å¦‚æœsearch-keyå­˜åœ¨é‡å¤ç°è±¡ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›é¢å¤–çš„å¤„ç†æ‰‹æ®µï¼Œæ¯”å¦‚

* åˆ›å»ºcomposite key å°†è¯¥keyå’Œä¸€äº›å…¶ä»–çš„keyæ”¾åœ¨ä¸€å—ä½œä¸ºsearch keyï¼Œè¾¾åˆ°uniqueçš„æ•ˆæœï¼Œä¸€èˆ¬å’Œprimary keyå‘¢ï¼Œå¯ä»¥å½¢æˆä¸€ç§range searchçš„æ•ˆæœ
* â€‹![image](assets/image-20240610131543-k5mo8g2.png)â€‹

* **ä¼°è®¡bpæ ‘çš„size**

â€‹![image](assets/image-20240610131826-xmz73m4.png)â€‹

### 5.4 other issues in indexing

**record relocation and secondary indices**

å¦‚æœä¸€ä¸ªè¡¨æœ‰å¤šä¸ªå±æ€§ï¼Œå¹¶ä¸”è¿™äº›å±æ€§ä¸Šé¢éƒ½å»ºç«‹äº†bpæ ‘ï¼Œå¦‚æœåˆ é™¤recordå°±éœ€è¦æ›´æ–°å¾ˆå¤šï¼Œè§£å†³æ–¹æ³•æ˜¯å¯ä»¥è®©secondary indexçš„å¶å­èŠ‚ç‚¹å­˜primary keyçš„å€¼

**indexing strings**

æ˜¯æŒ‡é‚£äº›search keyæ˜¯å¯å˜é•¿åº¦çš„ï¼Œæ¯”å¦‚stringä¸­çš„varcharï¼Œå› ä¸ºå¦‚æœéƒ½å–æœ€å¤§å€¼çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´bpæ ‘åˆ†æ”¯å˜å°‘ï¼Œä»è€Œå¯¼è‡´æ•ˆç‡ä¸‹é™ï¼Œå› æ­¤æˆ‘ä»¬ä¼šåœ¨è¿™é‡Œä½¿ç”¨prefix compression

* use space utilization as criterion for splitting å°†ç©ºé—´åˆ©ç”¨ç‡ä½œä¸ºåˆ†è£‚çš„æ ‡å‡†
* åŠ¨æ€çš„fanout, fanoutå°±æ˜¯N

ç±»ä¼¼äºhuffman treeï¼Œåªè¦èƒ½åšåŒºåˆ†çš„æœ€å°‘bit

**bulk loading and bottom-up build**

å¤§é‡æ•°æ®æ’å…¥çš„ä¼˜åŒ–

bulk loading æ‰¹é‡æ’å…¥

* insert in sorted order
* bottom-up B+ tree construction

  * æ¯ä¸ªå¶å­èŠ‚ç‚¹éƒ½æ’æ»¡ï¼Œæœ€åä¸¤ä¸ªéœ€è¦è°ƒèŠ‚ä¸€ä¸‹ï¼Œåšåˆ°åŠæ»¡å³å¯
  * â€‹![image](assets/image-20240617170332-x5hhr6g.png)â€‹
  * é¦–å…ˆæ’åº
  * æ„å»º
  * the built B+ tree is written to disk using sequential IO operations(æé«˜åç»­è®¿é—®çš„æ•ˆç‡) å¶å­pageéƒ½é¡ºåºæ”¾åœ¨ä¸ä¸€èµ·
  * å¯¹äºä¸Šè¿°ä¾‹å­ï¼Œ1seek+9 block transfers å°±å®Œæˆäº†ç”Ÿæˆ
* ä¸Šè¿°çš„æƒ…å†µæ˜¯B+æ ‘ç”Ÿæˆçš„ç»“æœï¼Œå¦‚æœæ˜¯å·²ç»æœ‰B+æ ‘ï¼ŒåŒæ—¶è¦æ’å…¥å¤§é‡æ•°æ®å‘¢

  * æ–°å»ºä¸€ä¸ªB+ tree åˆå¹¶ï¼Œå½¢ä¼¼æŠŠå¶å­èŠ‚ç‚¹å½’æ’åº
  * 2seeks + 19 block transfers
  * â€‹![image](assets/image-20240617201511-ukmrpfe.png)â€‹

**multiple-key access**

æœ‰ä¸¤ä¸ªå…ƒç´ çš„ç­›é€‰

* A Béƒ½æ— ç´¢å¼•ï¼Œæ‰«æ
* A æœ‰ B æ— ï¼Œå–Aï¼Œæ‰«æB
* A Béƒ½æœ‰ å–å¹¶é›†åˆ

æˆ–è€…æ˜¯å»ºç«‹ composite search key (a,b) (a,b)

**indexing in main memory**

B+ tree with small nodes that fit in cache line are preferable to reduce cache missesï¼Œè¿™ç§åšæ³•ç§°ä¸º cache conscious

â€‹![image](assets/image-20240617202330-g6u6dh3.png)â€‹

### 5.5 Write Optimized

â€‹![image](assets/image-20240617202836-p9afvg7.png)â€‹

flashä¸Šçš„ç´¢å¼•æœ€å¥½èƒ½ç”¨Write-optimized tree structuresï¼Œå¯¹äºå†™é¢‘ç¹çš„diskä¹Ÿé€‚ç”¨ï¼Œè¿™é‡Œä»‹ç»ä¸¤ç§

* LSM tree
* buffer tree

**log structured merge tree LSM**

â€‹![image](assets/image-20240617203036-o2jibnb.png)â€‹

ç°åœ¨å†…å­˜é‡Œå»ºç«‹ç´¢å¼•ç»“æ„ï¼Œè®¾å®šä¸€ä¸ªä¸Šé™ï¼Œè¾¾åˆ°ä¸Šé™åå†™å…¥ç£ç›˜ï¼Œå˜ä¸º1çº§B+ treeï¼Œè‡ªåº•å‘ä¸Šï¼Œä¸æ–­åœ°åŠ å…¥1çº§ï¼Œç„¶åmerge

æ˜¾ç„¶å„çº§çš„B+ treeéƒ½æœ‰ä¸€ä¸ªä¸Šé™ï¼Œè¶…å‡ºä¸Šé™ä¹‹åå°±mergeåˆ°ä¸‹ä¸€å±‚

ä¸€èˆ¬Li+1ä¼šæ¯”Liå¤§kå€

æ›´ä¼˜åŒ–ä¸€ç‚¹ï¼Œå¯¹æ¯å±‚éƒ½å®‰æ’å¤šä¸ªB+ treeï¼Œç›´æ¥æŠŠæ¯å±‚çš„mergeéƒ½å†™å…¥ä¸‹ä¸€å±‚

â€‹![image](assets/image-20240617203631-c62nhgz.png)â€‹

å¦‚æœè¦æŸ¥æ‰¾ï¼Œè¦å¯¹æ‰€æœ‰çš„B+ treeéƒ½searchï¼Œå¯¹äºlookupä¹Ÿæœ‰ä¼˜åŒ–ï¼ŒBloom filter

é€šè¿‡ä¸€ä¸ªBloom filterï¼Œå¯ä»¥å¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦åœ¨è¿™ä¸ªB+treeä¸Šï¼Œè™½ç„¶åˆ¤æ–­æˆåŠŸä¹Ÿä¸ä¸€å®šåœ¨ï¼Œbloom filteræ˜¯ä¸€ä¸ªbitæ•°ç»„ï¼Œæœ‰ä¸€ä¸ª hash å‡½æ•°ï¼Œhashå‡½æ•°çš„è¾“å‡ºä½æ•°å’Œbitæ•°ç»„çš„ä½æ•°ä¸€æ ·ï¼Œå°†B+treeçš„search keyèŒƒå›´å†…çš„æ•°å­—å…¨åšä¸€éhashï¼Œå°†å…¶ä¸­ä¸º1çš„ä½æ•°ï¼Œç›¸åº”çš„bloom filterçš„ä½æ•°ä¹Ÿç½®1ï¼Œå·²ç»ä¸º1å°±ä¸æ”¹äº†

æ­¤æ—¶æ¥äº†ä¸€ä¸ªsearch keyï¼Œå¦‚æœå…¶hashä¹‹åçš„å€¼æœ‰ä¸€ä¸ª1è½åœ¨äº†0ä¸Šï¼Œå¿…ç„¶å°±ä¸åœ¨è¿™ä¸ªB+æ ‘ä¸Š

å¦‚æœè¦åˆ é™¤ï¼Œé‚£ä¹ˆä¸€èˆ¬å°±æ˜¯æ‰“ä¸Šdelete entriesï¼Œåœ¨mergeçš„æ—¶å€™å®é™…ä¼¤å¤„

**buffer Tree**

æˆ‘å¯¹äºä¸­é—´èŠ‚ç‚¹åšä¸€ä¸ªä¼˜åŒ–ï¼Œæ¯ä¸ªä¸­é—´èŠ‚ç‚¹ä¼šåˆ†é…ä¸€ç‚¹ç©ºé—´ç”¨æ¥åšbuffer

â€‹![image](assets/image-20240617204740-aokhn1c.png)â€‹

æ’å…¥çš„æ—¶å€™å…ˆå§‘ä¸”æ’åœ¨å†…éƒ¨èŠ‚ç‚¹çš„è¿™ä¸ªbufferé‡Œé¢ï¼Œå½“bufferæ»¡çš„æ—¶å€™å†å‘ä¸‹é¢æ’ï¼Œå¦‚æœä¸‹é¢çš„bufferæœ‰ç©ºå°±æ’åœ¨ä¸‹é¢ï¼Œç›´åˆ°ä¸¢åˆ°leafé‡Œé¢

å› ä¸ºå†…éƒ¨èŠ‚ç‚¹åœ¨bufferé‡Œçš„æ¦‚ç‡æ›´å¤§ï¼Œè¿™ä¹ˆåšæœ‰åˆ©äºå‡å°‘IOï¼Œå†™ä¼˜åŒ–

**ç¼ºé™·**

fanoutå°‘äº†ï¼Œæ ‘çš„ç»“æ„å˜å¾—ä¸å¤ªä¼˜äº†

### 5.6 bitmap index*

bitmap indices are a special type of index designed fro efficient querying on multuple keys

é€‚ç”¨äºé‚£äº›å–å€¼å­˜åœ¨ç¦»æ•£çš„æœ‰é™èŒƒå›´çš„å±æ€§ï¼Œæ¯”å¦‚æ€§åˆ«ï¼Œå›½å®¶ç­‰ç­‰

ä»–ä¼šå¯¹å–å€¼çš„èŒƒå›´å»ºç«‹ä¸€ä¸ªbitæ•°ç»„

â€‹![image](assets/image-20240619200130-f23o9q8.png)â€‹

100wä¸ªbitså¦‚ä½•ç»Ÿè®¡æœ‰å¤šå°‘ä¸ª1,100wä¸ªbitï¼Œå¯ä»¥è€ƒè™‘åˆ†æˆä¸€å †bytesï¼Œç„¶åå»ºç«‹byteså€¼å’Œ1æ•°é‡çš„æ˜ å°„ï¼Œè¿›è¡Œå¾ªç¯ç»Ÿè®¡

â€‹![image](assets/image-20240619200411-z1crr6x.png)â€‹

## 6. Query Processing

### 6.1 basic steps

* Parsing and translation è¯­æ³•åˆ†æå’Œç¿»è¯‘
* optimization
* evaluation

An evaluation plan defines exactly what algorithm is used for each operation, and how the execution of the operations is coordinated.

å¯¹äºQueryè€Œè¨€ï¼Œæœ€å¸¸è§çš„è¡¡é‡æ–¹æ³•æ˜¯ï¼Œæ›´å…³æ³¨response time

* the number of block transfers from disk ä¼ è¾“çš„æ—¶é—´
* the number of seeks æœç´¢çš„æ—¶é—´ï¼Œåªæœ‰ä¸è¿ç»­çš„æ—¶å€™éœ€è¦ç”¨åˆ°

ç”±äºbufferçš„ä½¿ç”¨åªæœ‰è¿è¡Œæ—¶æ‰èƒ½è¡¡é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬å°±ä½¿ç”¨worst case estimates

### 6.2 Selection

10ç§

**scan**

* File Scan
* Index Scan

**selection**

### 6.3 Sort* 

å¤–æ’åº

Mè¡¨ç¤ºå†…å­˜çš„å¤§å°ï¼Œbrè¡¨ç¤ºå…³ç³»rä¸­çš„blockçš„æ•°é‡ï¼Œå¯¹äºN-way mergeï¼Œæ˜¯æŒ‡ä¸€æ¬¡å½’å¹¶Nä¸ªblock

* å¦‚æœN<M ä¸€æ¬¡å®Œæˆ

  * ç”¨Nä¸ªblockä½œä¸ºinputï¼Œç”¨ä¸€ä¸ªblockä½œä¸ºè¾“å‡ºï¼Œä¸æ–­åšå½’å¹¶æ’åºï¼Œå½“è¾“å‡ºblockæ»¡äº†å°±å†™å…¥ç£ç›˜
* å¦‚æœN>=M

  * æ¯ä¸ªpassæ”¾M-1ä¸ª

å¯¹äºä¸€æ¬¡å½’å¹¶æ’åºè€Œè¨€

* æ¯æ¬¡éœ€è¦2brä¸ªæ•°æ®ä¼ è¾“
* æ¯æ¬¡ä½¿å¾—éœ€è¦å½’å¹¶çš„æ®µæ•°é™ä¸º1/(M-1)æ‰€ä»¥æ€»å¾—å½’å¹¶æ¬¡æ•°ä¸º$\lceil\log_{M-1}(b_r/M)\rceil$
* æœ€åä¸€è¶Ÿåªéœ€è¦ä¸€ä¸ªbrçš„æ•°æ®ä¼ è¾“ï¼Œå› ä¸ºç»“æœå¯ä»¥ä¸å†™å›ç£ç›˜ï¼Œæ€»å¾—æ•°æ®ä¼ è¾“æ¬¡æ•°ä¸º![image](assets/image-20240610135353-4l6vr62.png)â€‹

* ç£ç›˜æœç´¢æ¬¡æ•°ä¸ºï¼Œå…¶ä¸­$b_b$ä¸ºç¼“å†²å—æ•°  
  â€‹![image](assets/image-20240610135532-hjibeaf.png)â€‹

PPTä¸Šç»™äº†ä¸€ä¸ªå¤æ‚ç‰ˆæœ¬å’Œç®€å•ç‰ˆæœ¬ P25

### 6.4 Join* hash join A4

5ç§joinç®—æ³•

* Nested-Loop Join:

  * â€‹![image](assets/image-20240610141144-wkqnqa5.png)â€‹
  * å…¶ä¸­ræ˜¯å¤–éƒ¨å…³ç³»ï¼Œsæ˜¯å†…éƒ¨å…³ç³»ï¼Œnræ˜¯rå†…éƒ¨çš„å…ƒç»„æ•°ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯ä¸ªrä¸­å…ƒç»„è¯»å–ä¸€æ¬¡sä¸­æ‰€æœ‰çš„blockï¼Œå¯ä»¥æ¨å‡ºblock transfer
  * block transfer: $n_r*b_s+b_r$
  * seeksï¼š$n_r+b_r$
  * å¦‚æœå…¶ä¸­ä¸€ä¸ªå…³ç³»èƒ½å®Œå…¨æ”¾å…¥ç£ç›˜ä¸­ï¼Œé‚£ä¹ˆå°†å…¶ä½œä¸ºå†…å±‚å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å‡ºåªéœ€è¦br+bsblock transferå’Œ2ä¸ªseeks
* Block Nested-Loop Join

  * block transfer $b_r*b_s +b_r$
  * seeks $2b_r$
  * â€‹![image](assets/image-20240610142058-rjl34rn.png)â€‹
* indexed nested-Loop Join

  * cost = $b_r(t_r+t_s)+n_r*c$ cæ˜¯é€šè¿‡è¿æ¥æ¡ä»¶å¯¹sè¿›è¡Œå•æ¬¡selectçš„ä»£ä»·
  * å¦‚æœrå’Œsä¸Šéƒ½æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆéœ€è¦æŠŠå…ƒç»„è¾ƒå°‘çš„å…³ç³»ä½œä¸ºå¤–å±‚
* Merge join

  * ç£ç›˜ä¼ è¾“æ¬¡æ•° bs+br
  * ç£ç›˜å¯»å€æ¬¡æ•° $\lceil br/bb\rceil+\lceil bs/bb\rceil$ æœ€åæƒ…å†µå°±æ˜¯br+bs
  * å’Œmerge sort å¾ˆåƒï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„åœ°æ–¹æ˜¯ï¼Œå¦‚æœä¸¤è¾¹åŒä¸€ä¸ªå€¼éƒ½æœ‰å¤šä¸ªï¼Œæ¯”å¦‚Aå¤„æœ‰ä¸¤ä¸ªï¼ŒBå¤„æœ‰ä¸‰ä¸ªï¼Œåˆ™éœ€è¦åš6ä¸ªé“¾æ¥ï¼Œåœ¨è¿™ç§æ—¶å€™éœ€è¦ä¸€ä¸ªå°å¾ªç¯
* Hash Join

  * ä»…ä»…ç”¨ä½œç­‰å€¼è¿æ¥å’Œè‡ªç„¶è¿æ¥ï¼ˆå…¶å®å°±æ˜¯ç‰¹æ®Šç­‰å€¼è¿æ¥ï¼‰
  * hashå‡½æ•°çš„å‚æ•°å°±æ˜¯ç­‰å€¼çš„å±æ€§
  * æŠŠhashå€¼ç›¸åŒçš„æ”¾åœ¨ä¸€èµ·
  * hashç´¢å¼•çš„keyå°±æ˜¯è¿æ¥çš„ç­‰å€¼æ¡ä»¶ hash function h is used to partition tuples of both relations with common JoinAttrs
  * â€‹![image](assets/image-20240616211421-b1gp7p0.png)â€‹
  * hashå€¼ä¸åŒçš„ï¼Œä¸€å®šé“¾æ¥ä¸ä¸Šï¼Œå¦‚æœhashç›¸åŒï¼Œä¹Ÿæœªå¿…é“¾æ¥å¾—ä¸Šï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—åœ¨å†…éƒ¨åšä¸¤é‡å¾ªç¯
  * è¦æ±‚æ˜¯hashçš„å—ï¼Œè‡³å°‘å°çš„é‚£ä¸ªèƒ½æ”¾åˆ°å†…å­˜é‡Œï¼Œnæ˜¯hashå€¼çš„ä¸ªæ•°ï¼ŒMæ˜¯ç¼“å†²å—çš„ä¸ªæ•°  
    â€‹![image](assets/image-20240616211846-fc9huz1.png)â€‹
* hash joinçš„è¿‡ç¨‹ï¼Œå…ˆpartitionï¼Œå†joinï¼Œæ³¨æ„partitionå¹¶éåŒæ—¶å‘ç”Ÿçš„
* â€‹![image](assets/image-20240619201716-uaxlz06.png)â€‹
* å…·ä½“é“¾æ¥çš„æ—¶å€™ï¼Œå¯¹äºsè¦å»ºç«‹in-memory hash index, è¿™ä¸ªhashå‡½æ•°å’Œä¹‹å‰é‚£ä¸ªä¸åŒï¼Œ
* build input èƒ½æ”¾åˆ°å†…å­˜é‡Œ
* probe input
* recursive partition required if number of partition n is greater than number of page M of memory

  * ä¹‹å‰è¯´èµ·ç è¦æœ‰ä¸€å—èƒ½æ”¾åœ¨å†…å­˜é‡Œï¼Œä¸‡ä¸€å°±æ˜¯æ”¾ä¸ä¸‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å¯¹é‚£äº›è¿‡å¤§çš„blockå†è¿›è¡Œä¸€ä¸ªhash partition
  * â€‹![image](assets/image-20240619202153-wwodcbl.png)â€‹
  * recursive partitionçš„ç•Œé™
  * â€‹![image](assets/image-20240619202933-7biyxfs.png)â€‹
  * â€

â€

## 7. Query Opimization

### generating equivalent expression

ä¸€ç³»åˆ—ç­‰ä»·åŸåˆ™

â€‹![image](assets/image-20240610144355-mx1ifzu.png)â€‹

åœ¨æ•°æ®åº“ä¸­è¿æ¥æ“ä½œæ˜¯æœ€å…³é”®çš„ï¼Œå¦‚æœè¿æ¥èƒ½åŒæ—¶åšç­›é€‰æœ€å¥½ä¸€èµ·åšäº†

* $\prod_{A}(\prod_{AB}(r))=\prod_{A}(r)$ æˆç«‹
* $\prod_{A}(\prod_{B}(r))=\prod_{A}(r)$ ä¸æˆç«‹ï¼Œæ€»ä¹‹Bè¦åŒ…å«A

â€‹![image](assets/image-20240619121259-8ts798z.png)â€‹

Theta-joinå¯ä»¥äº¤æ¢ï¼Œè¯´æ˜natural joinæ˜¯å¯ä»¥äº¤æ¢ï¼Œnatural joinä¹Ÿæ˜¯å¯ä»¥ç»“åˆçš„

åé¢è¿˜æœ‰å¾ˆå¤šè¯¦ç»†è§PPT

union and intersection

### statistics for cost estimation* ç›´æ–¹å›¾

* space requirements reduced by sharing common sub-expressions
* time requirements are reduced by not generating all expressions

ä¸‹é¢æ˜¯ä¸cost estimationç›¸å…³çš„ä¸€äº›å…ƒç´ 

â€‹![image](assets/image-20240619122038-783p15r.png)â€‹

æ¥ä¸‹æ¥æ˜¯æˆ‘ä»¬é€šè¿‡ä¸€äº›é¢å¤–çš„ä¿¡æ¯æ¥è¯„ä¼°æŸ¥è¯¢çš„ç»“æœ

**Histograms**

ç›´æ–¹å›¾

â€‹![image](assets/image-20240619122734-akvc0ga.png)â€‹

å¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„ä¼°ç®—ï¼Œè§æœ‹è¾ˆ*

**æ ¹æ®æœ€å¤§æœ€å°å€¼selectä¼°è®¡**

* å¦‚æœæ˜¯key åˆ™ç»“æœsizeä¸º1ï¼Œç­‰äºæŸ¥è¯¢
* â€‹![image](assets/image-20240619123130-9eu4ub4.png)â€‹
* å¦‚æœå¯¹äºå¤åˆçš„æŸ¥è¯¢ï¼Œconjunction disjunctionç­‰
* â€‹![image](assets/image-20240619123346-6eqp8vg.png)â€‹

â€

### estimation of the size of join

* è‹¥ä¸ºç®€å•çš„ç¬›å¡å°”ç§¯ rxs ç»“æœå°±æ˜¯ä¸¤ä¸ªå…ƒç»„æ•°ç›¸ä¹˜ nr * ns
* è‹¥ä¸º$R\cap S=\varnothing$ï¼Œåˆ™ $r \Join s = r \times s$
* è‹¥$R \cap S$ is a key for R, $r \Join s \le n_s$
* è‹¥$R\cap S$ is a foreign key in S referencing Rï¼Œ$r\Join s = n_s$ ä¹Ÿæœ‰ä¸€ä¸ªå‰ææ˜¯foreign keyä¸ä¸ºç©ºï¼Œå®é™…ä¸Šå³ä½¿å­˜åœ¨foreign key çº¦æŸä¹Ÿå¯ä»¥ä¸ºnull
* å¦‚æœä¸å­˜åœ¨keyçº¦æŸï¼Œé‚£ä¹ˆä¸€èˆ¬ç»“æœä¸º $\min\{ \frac{n_r*n_s}{V(A,s)},\frac{n_r*n_s}{V(A,r)} \}$

### estimation of number of distinct value

æˆ‘ä»¬åœ¨ä¹‹å‰ç”¨åˆ°äº†å¾ˆå¤šæ¬¡ V(A,r) ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦èƒ½å¤Ÿä¼°è®¡ä¸­é—´ç»“æœçš„V(A, r)ï¼Œä»¥ä¾¿èƒ½å¤Ÿåç»­å¤„ç†ã€‚

**selectçš„V(A,r)ä¼°è®¡** **$\sigma_{\theta}(r)$** æ±‚ $V(A,\sigma_{\theta}(r))$  

* è‹¥ $\theta$ çš„ç­›é€‰æ˜¯ä¸€ä¸ªç‰¹å®šçš„å€¼ï¼Œé‚£ä¹ˆV = 1
* å¦‚æœç­›é€‰æ˜¯ä¸€ç³»åˆ—ç‰¹å®šçš„å€¼ï¼Œé‚£ä¹ˆå°±åŠ èµ·æ¥
* å¦‚æœç­›é€‰æ˜¯ä¸€ä¸ªèŒƒå›´ V = V(A, r) * s sæ˜¯selectivity of the selection
* â€‹![image](assets/image-20240619131332-pzj0s27.png)â€‹

**join çš„ä¼°è®¡**

â€‹![image](assets/image-20240619131419-8tx6y2l.png)â€‹

### å…¶ä»–çš„sizeä¼°è®¡

â€‹![image](assets/image-20240619125634-5wk0n4x.png)â€‹

### choice of evaluation plan

**cost-based join-order selection**

å¦‚æœæœ‰r1-rnä¸ªå…³ç³»åšnatural join

â€‹![image](assets/image-20240619131820-c5edsg4.png)â€‹

å®é™…çš„åšæ³•æ˜¯é‡‡ç”¨åŠ¨æ€è§„åˆ’å»ä¼˜åŒ–ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å…ˆæ‰¾åˆ°äº†1-3çš„æœ€ä¼˜è§£ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åªè¦æŠŠ1-3çœ‹åšä¸€ä¸ªæ•´ä½“ï¼Œå’Œ4,5ï¼Œåˆæ˜¯3ä¸ªå…³ç³»çš„æ’åºï¼Œ12+12

â€‹![image](assets/image-20240619132112-sq7tfze.png)â€‹

å…ˆåˆ†è§£æˆä¸¤ä¸ªå°çš„é›†åˆ $ğ‘†_1,ğ‘†âˆ’ğ‘†_1.$é€’å½’åœ°ç»†åˆ†ã€‚é€’å½’åˆ°æœ€åº•å±‚å°±å˜ä¸ºäº†å¯¹å•ä¸ªè¡¨çš„é€‰æ‹©æ–¹æ³•ã€‚

æ—¶é—´å¤æ‚åº¦åˆ†æï¼Œä½†å®é™…å¯èƒ½ä¼šé‡‡ç”¨left-deep join treeï¼Œæ‰¾åˆ°çš„æœªå¿…æ˜¯æœ€ä¼˜ï¼Œä½†æ˜¯èƒ½é™ä½æ—¶é—´å¤æ‚åº¦

â€‹![image](assets/image-20240619132819-4gpdc6e.png)â€‹

**heuristic optimization å¯å‘å¼ä¼˜åŒ–**

cost-based optimization å³ä¾¿æ˜¯ä½¿ç”¨äº† dpä¹Ÿä¾æ—§éå¸¸expensiveï¼Œsystemæœ‰æ—¶ä¼šé‡‡ç”¨å¯å‘å¼çš„æ–¹æ³•reduce the number of choices that must be made in a cost-based fashion

â€‹![image](assets/image-20240619133243-4tiv6ai.png)â€‹

### additional optimization technique

**optimizing nested subquery**

â€‹![image](assets/image-20240619134239-y5nn007.png)â€‹

ä¸€ä¸ªç®€å•çš„æƒ³æ³•æ˜¯å°†å…¶è½¬æ¢æˆjoinæ“ä½œï¼Œå› ä¸ºå¾ªç¯ç€æ¯æ¬¡åšä¸€æ¬¡å­æŸ¥è¯¢ï¼Œå¼€é”€ä¼šéå¸¸å¤§

â€‹![image](assets/image-20240619134329-ovczt8c.png)â€‹

å¯ä»¥ä½¿ç”¨semijoinæ“ä½œæ¥æ›¿ä»£existsç­‰è¿ç®—

### æˆæœ¬ä¼°è®¡

ä¸­é—´ç»“æœè¦å°‘

cost-based query optimization

* generate logically equivalent expression å…ˆç­›é€‰
* Annotate resultant expression in alternative ways to get alternative query plan
* choose cheapest plan based on estimated cost

å¯ä»¥ä½¿ç”¨explain <query>è®©æ•°æ®åº“å¼•æ“æ¥è§£é‡Šquery plan

è¯„ä¼°æ‰§è¡Œè®¡åˆ’çš„cost

è¶Šå°è¶Šç²¾ç¡®

ä¼°è®¡distinct values

**é€‰æ‹©æˆæœ¬**

* A=vç­‰ä»·é€‰æ‹©ï¼Œè‹¥å–å€¼æ˜¯å‡åŒ€åˆ†å¸ƒçš„ï¼Œå¦‚æœ‰ä¸€ä¸ªç›´æ–¹å›¾ï¼Œå¯ä»¥ç”¨n/Vï¼Œnä¸ºè¯¥åŒºåŸŸå†…å…ƒç»„ä¸ªæ•°ï¼ŒVæ˜¯è¯¥åŒºåŸŸå†…å€¼çš„ä¸ªæ•°
* A<=v ![image](assets/image-20240610183545-5unk939.png)â€‹

å¯¹äºå¤æ‚çš„é€‰æ‹©

â€‹![image](assets/image-20240610183828-oq0h221.png)â€‹

s1å°±æ˜¯æŒ‡æ»¡è¶³$\theta1$çš„è®°å½•ä¸ªæ•°

**è¿æ¥æˆæœ¬**

â€‹![image](assets/image-20240610184328-v1xyc9o.png)â€‹

V(A, r) è¡¨ç¤ºå…³ç³»rçš„Aå±æ€§ä¸Šå¤šå°‘ç§ä¸åŒçš„A

### ä¼˜åŒ–çš„å¯å‘æ€§æ€è·¯Heuristic

é€‰æ‹©ä¼˜å…ˆç­‰ç­‰

é€‰æ‹©ç®—å­çš„æ’åº

## 8. transaction

ACID

### äº‹åŠ¡éš”ç¦»æ€§

å°±æ˜¯è¦è®©äº‹åŠ¡è¡¨ç°å¾—åƒæ˜¯ä¸²è¡Œçš„ä¸€æ ·

* å¯ä¸²è¡ŒåŒ–

  * å†²çªå¯ä¸²è¡ŒåŒ– è‹¥ä¸€ä¸ªè°ƒåº¦å’Œä¸€ä¸ªä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·ï¼Œåˆ™è¯´æ˜å…¶æ˜¯å†²çªå¯ä¸²è¡ŒåŒ–çš„
  * å†²çªï¼Œæ˜¯æŒ‡æŒ‡å‘ä¸€ä¸ªå…ƒç´ çš„ä¸¤ä¸ªçš„æ“ä½œï¼Œå…¶ä¸­è‡³å°‘ä¸€ä¸ªæ˜¯å†™
  * å†²çªç­‰ä»· conflict equivalentï¼Œæ˜¯æŒ‡æˆ‘ä»¬å¯ä»¥é€šè¿‡äº¤æ¢ä¸€ç³»åˆ—éå†²çªæŒ‡ä»¤æ¥è½¬æ¢ä¸¤ä¸ªè°ƒåº¦ï¼Œåˆ™ç§°ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·
  * ä¼˜å…ˆå›¾ precedence graph $T_i\rightarrow T_j$ æ˜¯æŒ‡Tiåœ¨Tjä¹‹å‰
  * åœ¨ä¼˜å…ˆå›¾ä¸­ï¼Œserializability order å¯ä»¥é€šè¿‡topological sortingè·å¾—
  * view serializability

**äº‹åŠ¡éš”ç¦»æ€§+åŸå­æ€§**

å¯æ¢å¤è°ƒåº¦ recoverable scheduleï¼Œæ¥çœ‹è¿™ä¹ˆä¸€ä¸ªè°ƒåº¦

â€‹![image](assets/image-20240611163836-7vpnvi7.png)â€‹

è‹¥T7æäº¤ä¹‹åï¼ŒT6å‘ç”Ÿäº†æ•…éšœï¼Œæ˜¾ç„¶ä¿æŒåŸå­æ€§ï¼ŒwriteAéœ€è¦è¢«å›æ»šï¼Œå› æ­¤æ­¤æ—¶T7çš„readç»“æœå°±æ˜¯ä¸€ä¸ªé”™è¯¯ç»“æœï¼Œä½†æ˜¯æ­¤æ—¶T6å·²ç»æäº¤äº†ï¼Œä¸èƒ½è¢«çº§è”å›æ»šï¼Œå› æ­¤æ­¤æ—¶ï¼Œè¿™ä¸ªè°ƒåº¦æ˜¯ä¸€ä¸ªä¸å¯æ¢å¤è°ƒåº¦

**æ— çº§è”è°ƒåº¦**

é¦–å…ˆæ— çº§è”è°ƒåº¦æœ¬èº«æ˜¯ä¸€ä¸ªå¯æ¢å¤è°ƒåº¦ï¼Œå¹¶ä¸”ç”±äºäº‹åŠ¡å‘ç”Ÿæ•…éšœå¯¼è‡´çš„å¾ˆå¤šäº‹åŠ¡å‘ç”Ÿå›æ»šï¼Œè¯¥ç°è±¡æˆä¸ºcascading rollback çº§è”å›æ»š

èƒ½å¤Ÿé¿å…cascading rollbackçš„è°ƒåº¦æ˜¯cascadeless schedule

**å››ç§SQLæ ‡å‡†çš„éš”ç¦»çº§åˆ«**

ç»Ÿè®¡ä¿¡æ¯çš„æ—¶å€™ä¸ä¸€å®šéœ€è¦ç²¾ç¡®

* Serializable æœ€é«˜éš”ç¦»
* Repeatable readï¼Œèƒ½æ‰¾åˆ°ä¸€äº›recordsï¼Œä½†æ— æ³•æ‰¾åˆ°å…¶ä»–çš„è®°å½•ã€‚éSerializable
* read committed
* read uncommitted æœ€ä½éš”ç¦»

## 9. concurrency control

ç»´æŠ¤éš”ç¦»æ€§å’Œä¸€è‡´æ€§ï¼Ÿ

ä¸¤é˜¶æ®µé”å¹¶éæ˜¯ä¸€ä¸ªå¿…è¦æ¡ä»¶ï¼Œè€Œåªæ˜¯å……åˆ†æ¡ä»¶

### 9.1 åŸºäºé”çš„åè®®

äº‹åŠ¡é”çš„è¯·æ±‚çš„é¥¿æ­»(starved)ï¼Œæ˜¯æŒ‡æœ‰ä¸€å †çš„äº‹åŠ¡å‘æ•°æ®åŠ å…±äº«é”ï¼Œä»¥è‡³äºæ’ä»–é”çš„è¯·æ±‚ä¸€ç›´ç­‰å¾…ä¸åˆ°

â€‹![image](assets/image-20240612103717-8ukt6e5.png)â€‹

æˆ‘ä»¬é€šè¿‡è®¾è®¡å…ˆåæ¡ä»¶ï¼Œä½¿å…¶ä¸è¢«å…¶åçš„åŠ é”è¯·æ±‚é˜»å¡

**ä¸¤é˜¶æ®µå°é”åè®®**

åªè¦æ ¹æ®lock-pointæ’åºï¼Œä¸¤é˜¶æ®µå°é”åè®®å¯ä»¥ç¡®ä¿Serializablility

è¯æ˜

* åè¯
* æ­£å‘ï¼šé€šè¿‡äº¤æ¢æ“ä½œï¼Œå¯ä»¥æŠŠlock pointæ—©çš„æ“ä½œå…¨éƒ¨äº¤æ¢åˆ°æœ€æ—©

åŒºåˆ†å¢é•¿é˜¶æ®µå’Œç¼©å‡é˜¶æ®µ

* strict two-phase locking protocol äº‹åŠ¡çš„æ’ä»–é”åœ¨äº‹åŠ¡æäº¤ä¹‹åæ‰èƒ½é‡Šæ”¾ï¼Œå¯ä»¥é¿å…çº§è”å›æ»š
* rigorous two-phase locking protocol äº‹åŠ¡åœ¨æäº¤ä¹‹å‰ä¸å¯é‡Šæ”¾ä»»ä½•é”

å¦‚ä½•åˆ¤æ–­è¿™ä¸ªè°ƒåº¦æ˜¯å¦ç”±ä¸¤é˜¶æ®µåè®®äº§ç”Ÿï¼Œæ˜¯æ ¹æ®äº‹åŠ¡åŠ é”çš„çŠ¶æ€æ¥çš„

â€‹![image](assets/image-20240616200918-eh6ix5q.png)â€‹

å¦‚ä¸Šå›¾æ˜¯ä¸€ä¸ªå¯ä¸²è¡ŒåŒ–çš„ï¼Œéä¸¤é˜¶æ®µçš„è°ƒåº¦

**éä¸¤é˜¶æ®µåè®®**

* å›¾çš„åè®®

**æ­»é”å¤„ç†**

* æ­»é”é¢„é˜²
* æ­»é”æ£€æµ‹+æ¢å¤ ç”»å›¾ï¼Œæ£€æµ‹ï¼Œé€‰æ‹©ä¸€ä¸ªç‰ºç‰²çš„äº‹åŠ¡ï¼Œæ¢å¤

  * total rollback
  * partial rollback

**é”åè®®çš„ç¼ºé™·**

æ­»é”

â€‹![image](assets/image-20240616194921-37xyh4y.png)â€‹

**lock conversion**

* lock-upgrade
* lock-downgrade

**lock table**

é›†ä¸­ç®¡ç†é”çš„managerï¼Œéœ€è¦ä¸€ä¸ªhash tableï¼Œå°†ä¸€ä¸ªæ•°æ®å”¯ä¸€æ ‡è¯†æ˜ å°„åˆ°ä¸€ä¸ªåœ°æ–¹

â€‹![image](assets/image-20240616202518-zin5a7b.png)â€‹

### 9.2 Graph-based Protocol

å¦‚æœæˆ‘ä»¬å¯¹æ•°æ®çš„ç»“æ„æ²¡æœ‰äº†è§£ï¼Œé‚£ä¹ˆä¸¤é˜¶æ®µåè®®æ˜¯åˆé€‚çš„ï¼Œå¦‚æœæˆ‘ä»¬å¯¹æ•°æ®å­˜åœ¨ä¸€å®šçš„äº†è§£ï¼Œé‚£ä¹ˆå¯ä»¥æ ¹æ®å…¶ç»“æ„ï¼Œä½¿ç”¨æ›´é«˜çº§çš„åè®®ï¼Œæ¯”å¦‚å¦‚æœæ•°æ®æ»¡è¶³ååºå…³ç³»

â€‹![image](assets/image-20240616202838-sfi62f5.png)â€‹

æ¯”å¦‚æˆ‘ä»¬éœ€è¦è®¿é—®Bï¼Œå¿…é¡»è¦è®¿é—®A

åœ¨è¿™é‡Œæˆ‘ä»¬è®²è§£æœ€ç®€å•çš„tree protocolç®—æ˜¯å›¾åè®®çš„ä¸€ç§ç‰¹åŒ–

â€‹![image](assets/image-20240616203010-kvej7he.png)â€‹

* åªæœ‰æ’ä»–é”
* ç¬¬ä¸€ä¸ªé”å¯ä»¥åŠ è½½ä»»ä½•åœ°æ–¹ï¼Œä¸éœ€è¦ä»rootå¼€å§‹ï¼›åç»­çš„é”ï¼Œå¿…é¡»è¦äº‰çˆ¶èŠ‚ç‚¹é”ä¸Š
* å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è§£é”
* æ¯ä¸ªæ•°æ®å¯¹ä¸€ä¸ªäº‹ç‰©ä»…èƒ½é”ä¸€æ¬¡

ä¼˜ç‚¹

* å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šæé«˜å¹¶å‘åº¦ï¼Œå› ä¸ºå¯ä»¥éšæ—¶é‡Šæ”¾
* ä¿è¯ä¸²è¡Œï¼Œé¿å…æ­»é”

ç¼ºé™·

* ä¹Ÿæœ‰ä¸€äº›ç¼ºé™·ï¼Œæ¯”å¦‚æˆ‘æƒ³è®¿é—®Gï¼ŒJï¼Œæˆ‘å°±å¿…é¡»é”ä¸Šå®ƒä»¬çš„å…¬å…±ç¥–å…ˆDï¼Œè™½ç„¶æˆ‘ä»¬å¯èƒ½å¹¶ä¸éœ€è¦è®¿é—®Då’ŒH
* ä¸ä¿è¯å¯æ¢å¤æ€§ï¼Œå¯æ¢å¤æ€§çš„å…³é”®åœ¨äºä¸è¯»è„æ•°æ®

### 9.3 **granularity***

### 9.4 insert and deletion

å‰é¢éƒ½æŠŠæ•°æ®åº“çš„æ“ä½œç®€åŒ–æˆäº†è¯»å’Œå†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨æ¥è€ƒè™‘å®é™…çš„insertå’Œdeleteæ“ä½œ

å¦‚æœä½¿ç”¨ä¸¤é˜¶æ®µé”

* æ•°æ®deleteä¹‹å‰éƒ½å¾—ç»™ä»–åŠ ä¸ŠXé”
* æ•°æ®insertä¹‹åè¦ç»™ä»–åŠ ä¸ŠXé”

ç¡®ä¿ä»¥ä¸‹ä¸¤ç‚¹

â€‹![image](assets/image-20240620143329-yej88ps.png)â€‹

åŒæ—¶ä¼šå¯¼è‡´å¹½çµé—®é¢˜ï¼Œæ¯”å¦‚ä¸€ä¸ªäº‹ç‰©çš„ä¸¤æ¬¡è¯»è¡¨ä¸­é—´ï¼Œå­˜åœ¨ä¸€ä¸ªäº‹ç‰©çš„æ’å…¥å’Œæäº¤ï¼Œä¼šå¯¼è‡´è¿™ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»ä¸ä¸€è‡´

é¿å…çš„æ–¹æ³•æ˜¯æ•´ä¸ªè¡¨åŠ ä¸ªé”ï¼Œå¯ä»¥é¿å…æ­»é”ï¼Œä½†æ˜¯æ•ˆç‡ä¼šä¸‹é™

index locking protocol to prevent phantoms

è°“è¯åŠ é”æœºåˆ¶å¯ä»¥é€šè¿‡index locking protocolæ¥å®ç°ï¼Œæ¯”å¦‚æˆ‘æ’å…¥äº†ä¸€æ¡å¹´é¾„ä¸º18çš„studentæ•°æ®ï¼Œæˆ‘å¯¹äºæ‰€æœ‰çš„å…³äºageåŒ…æ‹¬18çš„æŸ¥è¯¢éƒ½éœ€è¦å†²çªæ‰ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„è°“è¯åŠ é”

åœ¨è¿™ä¸ªåè®®ä¸Šï¼Œå°±åœ¨indexçš„å¶å­ä¸ŠåŠ é”ï¼Œæ¯”å¦‚åœ¨18å²æ‰€åœ¨çš„å¶å­ä¸ŠåŠ é”

â€‹![image](assets/image-20240620143943-7ysbsgi.png)â€‹

è¿˜æœ‰å¦ä¸€ä¸ªåè®®

â€‹![image](assets/image-20240620144501-yl73fv0.png)â€‹

### 9.5 multiversion locking

å¯¹äºæ•°æ®äº§ç”Ÿä¸€ç³»åˆ—æ–°çš„ç‰ˆæœ¬

äº‹åŠ¡è¦å£°æ˜åªè¯»è¿˜æ˜¯è¯»å†™

â€‹![image](assets/image-20240620144923-whx74ny.png)â€‹

* update

  * â€‹![image](assets/image-20240620145002-adytgkc.png)â€‹
* read-only

  * â€‹![image](assets/image-20240620145009-nr45x2a.png)â€‹

â€‹![image](assets/image-20240620145057-1jmlh1m.png)â€‹

read-only äº‹åŠ¡ä¹Ÿéœ€è¦æ—¶é—´æˆ³ï¼Œä½†æ˜¯ä¸éœ€è¦ä»»ä½•é”

â€

## 10. recovery

æ¢å¤æœ¬èº«æ˜¯è¦ä¿æŒè¿™ä¸¤ä¸ªæ€§è´¨

1. **Durability**: äº‹åŠ¡ä¸€æ—¦å®Œæˆï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šä¸¢å¤±äº‹åŠ¡çš„ç»“æœ
2. **Atomicity**: äº‹åŠ¡æ°¸è¿œä¸ä¼šå¤„äºä¸­é—´æ€ï¼Œè¦ä¹ˆå®Œæˆï¼Œè¦ä¹ˆå®Œæˆä¸åš

æ•…éšœå‘ç”Ÿçš„åŸå› 

1. transaction failure: ä¾‹å¦‚éæ³•è¾“å…¥ï¼Œéæ³•æ›´æ–°ï¼Œæ­»é”ç­‰ï¼Œlogical error/system error
2. system crash: power failure hardware/software failure
3. disk failureï¼šhead crash

å¯¹äºDatabase recoveryæˆ‘ä»¬è¦é‡‡ç”¨strict two-phase locking ensure no dirty read

å¹¶ä¸”è¦ä¿è¯idempotent

### 10.1 stable storage*

æˆ‘ä»¬è¿™é‡Œæå‡ºä¸€ç§æ–°çš„storageï¼Œæ¯”nonvolatile storageæ›´é«˜ä¸€å±‚çš„stable storageï¼Œè§†ä¸ºä¸€ç§å¯ä»¥æŠµå¾¡ä»»ä½•failureçš„ç†æƒ³ä»‹è´¨

* a mythical form of storage that survives all failures

ä¹¦æœ¬ä¸Šç®€å•ä»‹ç»äº†è¿™ç§ä»‹è´¨çš„å®ç°ï¼Œæœ‰ä»¥ä¸‹ä¸‰ä¸ªæ€§è´¨

* Maintain multiple copies of each block on separate disks
* Failure during data transfer can still result in inconsistent copiesï¼Œå­˜åœ¨ä¸‰ç§æƒ…å†µ

  * successful completion
  * partial failure
  * total failure
* Protecting storage media from failure during data transfer

  * æ‰§è¡Œoutput operation è¦ç»´æŠ¤ä¸¤ä¸ªblock

    1. å†™åˆ°ç¬¬ä¸€ä¸ªphysical block
    2. ç¬¬ä¸€ä¸ªå†™æˆåŠŸäº†ï¼Œå°†ç›¸åŒä¿¡æ¯å†™åˆ°ç¬¬äºŒä¸ª
    3. ç¬¬äºŒä¸ªå†™å…¥æˆåŠŸä¹‹åæ‰ä¼šè¾“å‡º

â€

### 10.2 log record

ä¸ºäº†ä¿æŒlogçš„æœ‰æ•ˆæ€§ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠlogå†™å…¥stable storageï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡å–ä¸€äº›æ‰‹æ®µæ¥å‡å°‘è¿™ä¸ªå†™çš„å¼€é”€

logçš„åŸºæœ¬å½¢å¼

â€‹![image](assets/image-20240616185609-i37tz66.png)â€‹

éµå¾ªwrite-ahead logging WAL æ—¥å¿—å…ˆå†™åŸåˆ™ï¼šå½“æ•°æ®ä»ä¸»å­˜outputåˆ°ç£ç›˜ä¸Šä¹‹å‰ï¼Œè¦å…ˆæŠŠlog recordå†™åˆ°stable storageä¸­

**deferred-modification and immediate-modification**

* deferred äº‹åŠ¡åœ¨æäº¤ä¹‹å‰éƒ½ä¸ä¿®æ”¹æ•°æ®ï¼šéœ€è¦å»ºç«‹ä¿®æ”¹æ•°æ®é¡¹çš„æœ¬åœ°å¤‡ä»½ï¼Œcommitä¹‹åé logå†™ï¼Œcrashä¹‹åï¼Œä¹‹æœ‰commitçš„éœ€è¦æŒ‰ç…§commitçš„é¡ºåºä¾æ¬¡redo
* immediate äº‹åŠ¡æ´»è·ƒçš„æ—¶å€™å°±ä¼šä¿®æ”¹æ•°æ®

**concurrency control and recovery**

éœ€è¦äº‹åŠ¡ä½¿ç”¨ä¸¥æ ¼ä¸¤é˜¶æ®µé”

### 10.3 checkpoint

redo/undo æ‰€æœ‰çš„äº‹åŠ¡ä¼šæ˜¯éå¸¸æ…¢çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦checkpoint

streamline recovery procedure by periodicalluy perfromaing checkpointing

* Output all log records currently residing in main memory onto stable storage.
* Output all modified buffer blocks to the disk
* Write a log record < checkpoint L> onto stable storage where L is a list of all transactions active at the time of checkpoint.
* åœ¨åšcheckpointæœŸé—´åœæ­¢æ‰€æœ‰çš„updates

æˆ‘ä»¬æ ¹æ®checkpointé‡Œçš„æ‰€æœ‰äº‹åŠ¡+checkpointä¹‹ålogé‡Œçš„äº‹åŠ¡ï¼Œè§†ä½œä¸€ä¸ªé›†åˆTï¼Œå¦‚æœTä¸­çš„äº‹åŠ¡Aå·²ç»commit/abort å°±æ‰§è¡Œredoï¼Œåä¹‹å°±åªæƒ³undo

**fuzzy checkpoint**

To avoid long interruption of normal processing during checkpointing, allow updates to happen during checkpointing

checkpointå…ˆæŠŠè„pageç»™è®°å½•ä¸‹æ¥ï¼Œéšåæ…¢æ…¢åœ°æŠŠè„pageå†™å…¥ç£ç›˜ï¼Œç›´åˆ°æœ€åä¸€ä¸ªè„pageå†™å…¥ç£ç›˜ï¼Œè®¾ç½®è¯¥checkpointæ˜¯æˆåŠŸçš„

**redo and undo**

æ­£å¸¸çš„äº‹åŠ¡å›æ»šä¸­åªåšundoï¼Œä»åå¾€å‰ï¼Œæ¯æ¬¡é‡åšå†™ä¸€ä¸ªåªè¯»çš„æ—¥å¿—CLR(compensation log record) æ‰¾åˆ°äº†startå°±å†™ä¸€ä¸ªabort

* redo

  * é‡åˆ°æ­£å¸¸æ—¥å¿—å’ŒCLRï¼ˆä¹Ÿæ˜¯redo-onlyæ—¥å¿—ï¼‰å°±é‡åš
  * é‡åˆ°T start åŠ åˆ°undo-listä¸­
  * é‡åˆ°T abort/commit å°±ä»undo listé‡Œé¢å»æ‰
* undo

  * undo listé‡Œé¢åšæ­£å¸¸äº‹åŠ¡å›æ»š

ä¸€ä¸ªä¾‹å­

â€‹![image](assets/image-20240616192054-ewvuvio.png)â€‹

### 10.4 log record buffer

åœ¨ä¹‹å‰æˆ‘ä»¬éƒ½å‡è®¾log recordç”Ÿæˆå°±å†™åˆ°stable storageä¸­ï¼Œä½†è¿™å®é™…ä¸Šæ¯”è¾ƒä½æ•ˆçš„ï¼Œäºæ˜¯æˆ‘ä»¬æœ‰äº†log record buffering

group commit: å°†ä¸€ä¸ªblockçš„logä¸€æ¬¡æ€§å†™å…¥stable storageï¼Œé™ä½IOå¼€é”€

ä¸ºäº†ç»´æŠ¤åŸå­æ€§ï¼Œè¦æ»¡è¶³ä¸€äº›æ€§è´¨

* Log records are output to stable storage in the order in which they are created.
* Transaction Ti enters the commit state only when the log record <Ti commit> has been output to stable storage.
* Before a block of data in main memory is output to the database, all log records pertaining to data in that block must have been output to stable storage. è¿™ä¸€å—å°±æ˜¯WALåŸåˆ™

**Database buffer**

* force æäº¤æ—¶å¼ºåˆ¶æŠŠæ‰€æœ‰ç›¸å…³page outputåˆ°disk
* no-force ç›¸å

* no-steal æ´»è·ƒäº‹åŠ¡çš„ç›¸å…³blockéƒ½ä¸èƒ½å†™åˆ°disk
* steal åä¹‹

å½“æˆ‘ä»¬è¦å†™ä¸€ä¸ªblockå›åˆ°ç£ç›˜çš„æ—¶å€™ï¼Œéœ€è¦å¯¹è¿™ä¸ªblockåŠ ä¸Šlatchï¼Œå¹¶ä¸”å°†ä¸ä¹‹ç›¸å…³çš„logå†™å…¥ç£ç›˜ï¼Œå†æŠŠblockå†™å…¥ç£ç›˜ï¼Œé‡Šæ”¾é”

### 10.5 Failure with loss of nonvolatile storage

ä¸Šè¿°è®¨è®ºçš„éƒ½æ˜¯å†…å­˜é‡Œæ•…éšœçš„æƒ…å½¢ï¼Œå¦‚æœè¿ç£ç›˜é‡Œå­˜çš„æ•°æ®éƒ½å‡ºé—®é¢˜äº†å‘¢

Periodically dump the entire content of the database to stable storage

dumpè¿‡ç¨‹è¦æ±‚ç±»ä¼¼äºä¸¥æ ¼çš„checkpoint

â€‹![image](assets/image-20240616193946-549v86w.png)â€‹

### 10.6 recovery with early lock release and logical undo operations*

æˆ‘ä»¬å› ä¸ºè¦æé«˜å¹¶å‘åº¦ï¼Œç‰¹åˆ«æ˜¯å¯¹bpæ ‘æ“ä½œçš„æƒ…å½¢ï¼Œå¯èƒ½ä¼šé‡‡ç”¨éä¸¤é˜¶æ®µçš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰å¯èƒ½æå‰é‡Šæ”¾é”

å¯¹äºè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦æ¢å¤æ˜¯åˆ é™¤è¯¥å…ƒç´ 

Recovery based on â€œrepeating historyâ€, whereby recovery executes exactly the same actions as normal processing

ä½†æ˜¯å¯¹äºbpæ ‘è€Œè¨€ï¼Œæˆ‘ä»¬ä¸èƒ½ç”¨physical undoï¼Œä¹Ÿå³é‡æ–°å­˜å‚¨old valueï¼›è€Œæ˜¯éœ€è¦æ‰§è¡Œlogical undoï¼Œå°±æ˜¯insertioné€šè¿‡deletionæ’¤é”€

### 10.7 Aries*

ARIES is a state of the art recovery method

* ä½¿ç”¨LSN log sequence number to identify log recordsï¼Œå°†ä¼šæŠŠLSNå­˜åˆ°pageä¸Š
* Physiological redo å—å½±å“çš„pageæ˜¯ç‰©ç†æ ‡å¿—çš„ï¼Œä½†å†…éƒ¨å¯èƒ½æ˜¯é€»è¾‘çš„
* Dirty page table
* Fuzzy checkpointing

â€‹![image](assets/image-20240613101624-70wa0va.png)â€‹

Special redo-only log record called compensation log record (CLR) used to log actions taken during recovery that never need to be undone.

â€‹![image](assets/image-20240613102031-e6ty0gq.png)â€‹

check point log record åŒ…æ‹¬

* Dirty Page Table åŒ…æ‹¬ PagLSN å’Œ RecLSN
* Active Transationï¼ŒLastLSN the LSN of the last log record

ARIESæµç¨‹

* Analysis pass ä¸éœ€è¦æ•°æ®åº“blockçš„ä¼ è¾“

  * ä»æœ€åçš„å®Œæ•´checkpointå¼€å§‹

    * è¯»Dirty Page Tableï¼Œå°†RedoLSNè®¾ç½®ä¸ºmin{RecLSN of all pages}ï¼Œå¦‚æœæ²¡æœ‰è„pageï¼Œé‚£ä¹ˆRedoLSNå°±æ˜¯checkpointçš„LSN
    * set undo-list = list of transactions in checkpoint log record
  * ä»checkpointå¼€å§‹scanæ—¥å¿—

    * å¦‚æœæœ‰ä¸ªäº‹åŠ¡ä¸å­˜åœ¨äºundo-listï¼Œå°†å…¶åŠ å…¥åˆ°undo-list
    * å¦‚æœæœ‰äº‹åŠ¡ç»ˆæ­¢äº†ï¼Œé‚£ä¹ˆå°†è¯¥äº‹åŠ¡ä»undo-listé‡Œåˆ é™¤
    * Keeps track of last log record for each transaction in undo-list
    * å¦‚æœå‘ç°æœ‰pageçš„æ›´æ–°è®°å½•ï¼Œé‚£ä¹ˆéœ€è¦æ›´æ–°çš„dirty page tableä¸Šï¼Œ

      å¦‚æœè¯¥é¡µä¸åœ¨è„é¡µè¡¨ä¸­ï¼Œåˆ†æé˜¶æ®µå°±å°†å®ƒåŠ è¿›è„é¡µè¡¨ã€‚å¹¶è®¾é‡è¯¥é¡µçš„RecLSNä¸ºè¯¥æ—¥å¿—è®°å½•çš„LSNã€‚
* Redo pass

  * ä»RedoLSNå¼€å§‹æ‰«ælogï¼Œåªå…³å¿ƒupdateæ“ä½œ
  * å¯¹äºè¿™ä¸ªæ—¥å¿—å¯¹åº”çš„pageï¼Œå¦‚æœè¯¥pageä¸åœ¨è„é¡µè¡¨ï¼Œæˆ–è€…æ›´æ–°æ—¥å¿—LSNå°äºè„é¡µè¡¨ï¼Œè·³è¿‡è¯¥æ—¥å¿—
  * åä¹‹ï¼Œå°±ä»ç£ç›˜è°ƒå‡ºè¯¥pageï¼Œå¦‚æœæ›´æ–°æ—¥å¿—LSNå¤§äºpageLSNï¼Œå°±é‡åš
* Undo pass

  * å¯¹æ—¥å¿—è¿›è¡Œåå‘æ‰«æï¼Œå¯¹undo-listé‡Œé¢æ‰€æœ‰äº‹ç‰©è¿›è¡Œæ’¤é”€
  * æ¯å½“æ‰¾åˆ°ä¸€ä¸ªéœ€è¦æ’¤é”€çš„æ—¥å¿—ï¼Œå°±æ‰§è¡Œä¸€ä¸ªundoï¼Œç”Ÿæˆä¸€ä¸ªCLRï¼Œå¹¶ä¸”æŠŠCLRçš„undoNextLSNè®¾ç½®ä¸ºè¯¥æ›´æ–°æ—¥å¿—è®°å½•çš„PrevLSN
  * å¦‚æœåå‘æ‰«æçš„æ—¶å€™é‡åˆ°CLRï¼Œç›´æ¥è½¬åˆ°undoNextLSNçš„ä½ç½®

$$
\prod_{A}(\prod_{AB}(r))=\prod_{A}(r)
$$

â€

â€
